{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block content %}
{% include 'nav.html' %}

<div class="container mypage">
  <div class="myinfo">
    <!-- 회원 정보 -->
    <div class="d-flex">
      <!-- 프로필 이미지 -->
      <div class="profile-img">
        {% if user.profile_image %}
        <img class="rounded-circle border border-2 me-3" src="{{ user.profile_image.url }}" alt="">
        {% else %}
        <img class="rounded-circle border border-2 me-3" src="https://dummyimage.com/200x200/ffffff/000000.png&text=no+image" alt="">
        {% endif %}
      </div>
      <!-- 정보 -->
      <div class="myinfo-content px-3">
        <!-- 드롭다운 -->
        {% if request.user == user %}
        <div class="dropdown dropdown-btn">
          <button class="dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fa-solid fa-ellipsis dropdown-icon"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{% url 'accounts:delete_check' %}">회원 탈퇴</a></li>
          </ul>
        </div>
        {% endif %}
        <!-- 닉네임 / 유저네임 -->
        {% if user.nickname %}
        <h4 class="user-name mb-3">{{ user.nickname }} 님의 책크리스트</h4>
        {% else %}
        <h4 class="user-name mb-3">{{ user.username }} 님의 책크리스트</h4>
        {% endif %}
        <!-- 리뷰/팔로워/팔로잉 수 -->
        <div class="d-flex">
          <div class="d-flex flex-column">
            <p class="text-center m-0">리뷰</p>
            <p class="text-center">0</p>
          </div>
          <div class="d-flex flex-column mx-3">
            <p class="text-center m-0">팔로워</p>
            <p class="text-center" id="followers-count">{{ user.followers.all|length }}</p>
          </div>
          <div class="d-flex flex-column">
            <p class="text-center m-0">팔로잉</p>
            <p class="text-center" id="followings-count">{{ user.followings.all|length }}</p>
          </div>
        </div>
        <!-- 상태 메세지 -->
        {% if user.status_message %}
        <p class="status-message">{{ user.status_message }}</p>
        {% else %}
        <p class="status-message">상태 메세지가 없어요</p>
        {% endif %}
        <!-- 프로필 수정 / 팔로우 버튼-->
        {% if request.user == user %}
        <a class="btn btn--main--reverse" href="{% url 'accounts:update' %}">프로필 수정</a>
        {% else %}
        <form id="follow-form" data-user-id="{{ user.pk }}" method="POST">
          {% csrf_token %}
          {% if request.user in user.followers.all %}
          <input class="btn btn--main--reverse" type="submit" value="언팔로우">
          {% else %}
          <input class="btn btn--main" type="submit" value="팔로우">
          {% endif %}
        </form>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- 활동 내역 -->
  <div class="tab-area">
    <!-- 탭 메뉴 -->
    <input type="radio" name="tabs" id="tab1" checked>
    <label for="tab1">작성한 리뷰</label>
    <input type="radio" name="tabs" id="tab2">
    <label for="tab2">좋아요한 리뷰</label>
    <input type="radio" name="tabs" id="tab3">
    <label for="tab3">좋아요한 책</label>
    <input type="radio" name="tabs" id="tab4">
    <label for="tab4">참여한 모임</label>

    <!-- 탭1 : 작성한 리뷰 -->
    <div id="content1" class="tab-content">
      <!-- 리뷰 작성 버튼 -->
      <a class="btn btn--main tab-create-btn" href="">리뷰 작성</a>
      <!-- 작성한 리뷰 리스트 -->
      <div class="row gx-5 mt-5">
        <!-- 반복문 시작 -->
        <div class="col-12 col-sm-6 col-md-4 col-lg-3 tab-card" style="cursor: pointer;" onclick="location.href='';">
          <div class="tab-review-card">
            (리뷰 내용)
          </div>
          <div class="mt-3">
            <h5>작성자</h5>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-md-4 col-lg-3 tab-card" style="cursor: pointer;" onclick="location.href='';">
          <div class="tab-review-card">
            (리뷰 내용)
          </div>
          <div class="mt-3">
            <h5>작성자</h5>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-md-4 col-lg-3 tab-card" style="cursor: pointer;" onclick="location.href='';">
          <div class="tab-review-card">
            (리뷰 내용)
          </div>
          <div class="mt-3">
            <h5>작성자</h5>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-md-4 col-lg-3 tab-card" style="cursor: pointer;" onclick="location.href='';">
          <div class="tab-review-card">
            (리뷰 내용)
          </div>
          <div class="mt-3">
            <h5>작성자</h5>
          </div>
        </div>
        <!-- 반복문 끝 -->
      </div>
    </div>

    <!-- 탭2 : 좋아요 리뷰 -->
    <div id="content2" class="tab-content">
      좋아요 리뷰 카드
    </div>

    <!-- 탭3 : 좋아요 책 -->
    <div id="content3" class="tab-content">
      <!-- 책 리스트 -->
      <div class="row gx-5 my-auto">
        <!-- 반복문 시작 -->
        <div class="col-12 col-sm-6 col-md-4 tab-card" style="cursor: pointer;" onclick="location.href='';">
          <img class="border tab-book-img" src="https://dummyimage.com/300x450/ffffff/000000.png&text=book+image" alt="">
          <div class="mt-3">
            <h5>제목</h5>
            <p>저자</p>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-md-4 tab-card" style="cursor: pointer;" onclick="location.href='';">
          <img class="border tab-book-img" src="https://dummyimage.com/300x450/ffffff/000000.png&text=book+image" alt="">
          <div class="mt-3">
            <h5>제목</h5>
            <p>저자</p>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-md-4 tab-card" style="cursor: pointer;" onclick="location.href='';">
          <img class="border tab-book-img" src="https://dummyimage.com/300x450/ffffff/000000.png&text=book+image" alt="">
          <div class="mt-3">
            <h5>제목</h5>
            <p>저자</p>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-md-4 tab-card" style="cursor: pointer;" onclick="location.href='';">
          <img class="border tab-book-img" src="https://dummyimage.com/300x450/ffffff/000000.png&text=book+image" alt="">
          <div class="mt-3">
            <h5>제목</h5>
            <p>저자</p>
          </div>
        </div>
        <!-- 반복문 끝 -->
      </div>
    </div>

    <!-- 탭4 : 참여한 모임 -->
    <div id="content4" class="tab-content">
      <!-- 모임 생성 버튼 -->
      <a class="btn btn--main tab-create-btn" href="">모임 생성</a>
      참여한 모임 카드
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  // 팔로우 비동기
  const form = document.querySelector('#follow-form')
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
  
  form.addEventListener('submit', function (event) {
    event.preventDefault()
    const userId = event.target.dataset.userId
    
    axios({
        method: 'post',
        url: `/accounts/${userId}/follow/`,
        headers: {'X-CSRFToken': csrftoken,}
    })
    .then((response) => {
        const isFollowed = response.data.is_followed
        const followBtn = document.querySelector('#follow-form > input[type=submit]')
        if (isFollowed === true) {
            followBtn.value = '언팔로우'
            followBtn.classList.add('btn--main--reverse')
            followBtn.classList.remove('btn--main')
        } else {
            followBtn.value = '팔로우'
            followBtn.classList.add('btn--main')
            followBtn.classList.remove('btn--main--reverse')
        }
        const followersCountTag = document.querySelector('#followers-count')
        const followingsCountTag = document.querySelector('#followings-count')
        const followersCount = response.data.followers_count
        const followingsCount = response.data.followings_count
        followersCountTag.innerText = followersCount
        followingsCountTag.innerText = followingsCount
    })
    .catch((error) => {
        console.log(error.response)
    })
  })

</script>

{% endblock content %}