{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block content %}
{% include 'nav.html' %}

<div class="rd-wrap"></div>

<!-- Review-detail -->
<div class="review-detail-wrap">
  <div class="container">

    <!-- review-countent & book-info-->
    <div class="detail-top-wrap">
      <!-- Review-countent -->
      <div class="review-content">
        {{ review.content }}
        <!-- review-content-dot -->
        {% if request.user == review.user %}
          <div class="review-content-dot">
            <div class="btn-group dropstart">
              <button type="button" class="dropdown-toggle" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
                <i class="fa-solid fa-ellipsis fa-2x"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-lg-end">
                <li><a class="dropdown-item" href="{% url 'reviews:update' review.pk %}">수정하기</a></li>
                <li><a class="dropdown-item" href="{% url 'reviews:delete' review.pk %}" style="color: var(--red-color);">삭제하기</a></li>
              </ul>
            </div>
          </div>
        {% endif %}
      </div>
      <hr>
      <!-- Book-info -->
      <div class="book-info">
        <a href="{% url 'books:detail' book.pk %}">
          <img src="{{ book.bookcover }}" alt="bookcover">
        </a>
        <div class="text">
          <p class="title">{{ book.bookname }}</p>
          <p class="author">{{ book.authors }}</p>
        </div>
      </div>
    </div>

    <!-- review-writer -->
    <div class="detail-bottom-wrap">
      <!-- review-writer -->
      <div class="review-writer">
  
        <!-- review-like -->
        <div class="review-like">
          <div class="count">
            <p id="like-count">{{ like_count }}</p>
          </div>
          <form class="review-like-forms" data-review-id="{{ review.pk }}">
            {% csrf_token %}
            {% if request.user in review_like_user.all %}
              <button id="like-{{ review.pk }}" class="button like-user-button" type="submit">
                <i class="fa-regular fa-heart fa-lg"></i>
              </button>
            {% else %}
              <button id="like-{{ review.pk }}" class="button" type="submit">
                <i class="fa-regular fa-heart fa-lg"></i>
              </button>
            {% endif %}
          </form>
        </div>
  
        <!-- review-writer-info -->
        <div class="review-writer-info">
          <a href="{% url 'accounts:detail' review.user.pk %}">
            <img src="{{ review.user.user_image }}" alt="writer-image">
          </a>
          <div class="username">
            <p>{{ review.user.username }}</p>
            <p>{{ review.updated_at }}</p>
          </div>
          <!-- review-user-followings -->
          <div class="follow">
            <form id="follow-form" data-user-id="{{ review.user.pk }}">
              {% csrf_token %}
              {% if request.user != review.user %}
                {% if request.user in review_user_follwers.all %}
                <button type='submit' class="btn btn--white--reverse">언팔로우</button>
                {% else %}
                <button type='submit' class="btn btn--white">팔로우</button>
                {% endif %}
              {% endif %}
            </form>
          </div>
        </div>
        
      </div>
      <!-- Comment-create -->
      <div class="comment-create">
        <img src="{{ request.user.user_image }}" alt="my-image">
        <form id="comment-form" data-review-id="{{ review.pk }}">
          {% csrf_token %}
          <input type="text" name="content" placeholder=" 댓글 남기기" required>
          <button type="submit" class="btn">게시</button>
        </form>
      </div>
      <!-- Comment-list -->
      <div class="comment-list">
        {% for comment in comments %}
        <!-- Comment-item -->
        <div class="comment-item">
          <!-- comment-item-top -->
          <div class="comment-top">
            <div class="writer">
              <div class="">
                <p>{{ comment.user.username }}</p>
                <p>{{ comment.created_at }}</p>
              </div>
            </div>
            <div class="button">
              {% if request.user == comment.user %}
              <a href="{% url 'reviews:comment_delete' review.pk comment.pk  %}">
                <button onclick="comment_delete(this)" id=" comment-delete-{{ comment.pk }}" data-commentdel-id="{{ comment.pk }}">
                  <span class="material-symbols-outlined me-2" style="font-size: 28px;">delete</span>
                </button>
              </a>
              {% else %}
              <i class="fa-regular fa-heart fa-lg me-2"></i>
              {% endif %}
            </div>
          </div>
          <!-- comment-item-bottom -->
          <div class="comment-item-bottom">
            <p>{{ comment.content }}</p>
          </div>
        </div>
        {% empty %}
        <div class="my-5" style="color: var(--gray-color);">
          <p>댓글이 없어요...</p>
        </div>
        {% endfor %}
      </div>
    </div>

  </div>
</div>

{% endblock content %}



{% block js %}

<!-- CDN axios -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


<!-- Background-snow -->
<script>
  function rdCreateSnow() {
    const reviewBg = document.querySelector('.rd-wrap');
    const rdEl = document.createElement("div");
    const bodyHeight = document.body.clientHeight;
    const plusNumber = 50;
    reviewBg.style.height = `${bodyHeight + plusNumber}px`;
    rdEl.classList.add("snow");
    rdEl.style.marginLeft = rdRandomPostion() + "px";
    reviewBg.appendChild(rdEl);
  }
  function rdRandomPostion() {
    return Math.floor(Math.random() * window.innerWidth);
  }
  for (let i = 0; i < 300; i++) {
    rdCreateSnow();
  }
</script>


<!-- Likes -->
<script>
  const forms = document.querySelectorAll('.review-like-forms')
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  forms.forEach((form) => {
    form.addEventListener('submit', function(evnet) {
      event.preventDefault();
      const reviewId = event.target.dataset.reviewId
      // request axios
      axios({
        method: 'post',
        url: `/reviews/${reviewId}/like/`,
        headers: {'X-CSRFToken': csrftoken}, // csrf token
      })
        // response views
        .then((response) => {
          const isLiked = response.data.is_liked
          const likeBtn = document.querySelector(`#like-${reviewId}`)
          const likeIcon = likeBtn.querySelector('i')
          const likeCountTag = document.querySelector('#like-count')
          const likeCount = response.data.like_count
          likeCountTag.innerText = likeCount
          if (isLiked === true) {
            likeBtn.style.background = "var(--yellow-color)";
            likeIcon.style.color = "var(--white-color)";
          } else {
            likeBtn.style.background = "var(--white-color)";
            likeIcon.style.color = "var(--yellow-color)";
          }
        })
        .catch((error) => {
          console.log(error.response)
        })
    })
  })
</script>


<!-- Followings -->
<script>
  const Form = document.querySelector('#follow-form')

  Form.addEventListener('submit', function(event) {
    event.preventDefault()
    const userId = event.target.dataset.userId
    // request axios
    axios({
      method: 'post',
      url: `/accounts/${userId}/follow/`,
      headers: {'X-CSRFToken': csrftoken}, // csrf token
    })
      // response views
      .then((response) => {
        const isFollowed = response.data.is_followed
        const followBtn = Form.querySelector('button');
        if (isFollowed === true) {
          followBtn.classList.remove('btn--white');
          followBtn.classList.add('btn--white--reverse');
          followBtn.innerText = '언팔로우';
        } else {
          followBtn.classList.remove('btn--white--reverse');
          followBtn.classList.add('btn--white');
          followBtn.innerText = '팔로우';
        }
      })
      .catch((error) => {
        console.log(error.response)
      })
  })
</script>


<!-- Comment Create -->
<script>
  const commentForm = document.querySelector('#comment-form')

  commentForm.addEventListener('submit', function(event){
    event.preventDefault()
    axios({
      method: 'post',
      url: `/reviews/${event.target.dataset.reviewId}/comment/create/`,
      headers: {'X-CSRFToken': csrftoken},
      data: new FormData(commentForm)
    })
    .then(response => {
      console.log(response.data)
      commentForm.reset()
      const comments = document.querySelector('.comment-list')
      comments.textContent = ""
      const comment_data = response.data.comment_data
      const user = response.data.user
      const userImage = response.data.userImage

      for (let i = 0; i < comment_data.length; i++){
        const review_pk = response.data.review_pk
        if (user === comment_data[i].user_pk){
          comments.insertAdjacentHTML('beforeend',  
          `
          <div class="comment-item">
            <div class="comment-top">
              <div class="writer">
                <div class="">
                  <p>${ comment_data[i].userName }</p>
                  <p>${ comment_data[i].commentDate }</p>
                </div>
              </div>
              <div class="button">
                <button onclick="comment_delete(this)" id="comment-delete-${comment_data[i].commentPk}" data-commentdel-id="${comment_data[i].commentPk}">
                  <span class="material-symbols-outlined me-2" style="font-size: 28px;">delete</span>
                </button>
              </div>
            </div>
            <div class="comment-item-bottom">
              <p>${ comment_data[i].content }</p>
            </div>
          </div>
          `)
        } else {
          comments.insertAdjacentHTML('beforeend',  
          `
          `)
        }
      }
    })
  })

</script>

{% endblock js %}
